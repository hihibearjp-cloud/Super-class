<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro+ç­ç´šå°ç®¡å®¶</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FEF9F2">
    
    <link rel="apple-touch-icon" id="ios-icon" href="">
    <link rel="icon" id="fav-icon" href="">

    <script>
        // å…¨å±€éŒ¯èª¤æ””æˆª
        window.onerror = function(msg, url, line, col, error) {
            var loading = document.getElementById('loading-screen');
            var errorLog = document.getElementById('error-log');
            if (loading) loading.style.display = 'none';
            if (errorLog) {
                errorLog.style.display = 'block';
                errorLog.innerHTML += "âš ï¸ ç³»çµ±éŒ¯èª¤: " + msg + "<br>Line: " + line + "<br>";
            }
            return false;
        };

        // å®‰å…¨å•Ÿå‹•è¨ˆæ™‚å™¨ (5ç§’å¾Œè‹¥æ²’åæ‡‰ï¼Œå¼·åˆ¶ç§»é™¤è¼‰å…¥ç•«é¢)
        setTimeout(function() {
            var loading = document.getElementById('loading-screen');
            if (loading && loading.style.display !== 'none' && loading.style.opacity !== '0') {
                if (!window.React) {
                    loading.innerHTML = '<h3 style="color:red">ç¶²è·¯é€£ç·šç•°å¸¸</h3><p>ç„¡æ³•è¼‰å…¥æ ¸å¿ƒç¨‹å¼åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>';
                }
            }
        }, 5000);

        // å‹•æ…‹ç¹ªè£½ç°¡æ½”è±¡å¾µç‰ˆ Logo (é»‘æ¿ + æ‰“å‹¾æ¸…å–®)
        window.onload = function() {
            try {
                var canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                var ctx = canvas.getContext('2d');
                
                // 1. èƒŒæ™¯ (æŸ”å’Œç±³è‰²)
                ctx.fillStyle = '#FEF9F2';
                ctx.fillRect(0, 0, 512, 512);
                
                // 2. æœ€å¤–å±¤è£é£¾æ¡† (æ·±å’–å•¡è‰²)
                ctx.strokeStyle = '#5D4037';
                ctx.lineWidth = 20;
                ctx.strokeRect(10, 10, 492, 492);

                // 3. é»‘æ¿æœ¨è³ªé‚Šæ¡†
                ctx.fillStyle = '#8D6E63'; // æœ¨é ­è‰²
                if (ctx.roundRect) {
                    ctx.beginPath();
                    ctx.roundRect(60, 100, 392, 280, 25);
                    ctx.fill();
                } else {
                    ctx.fillRect(60, 100, 392, 280);
                }

                // 4. é»‘æ¿è¡¨é¢ (æ·±ç¶ è‰²)
                ctx.fillStyle = '#2E7D32'; // æ·±ç¶ æ¿è‰²
                if (ctx.roundRect) {
                    ctx.beginPath();
                    ctx.roundRect(85, 125, 342, 230, 15);
                    ctx.fill();
                } else {
                     ctx.fillRect(85, 125, 342, 230);
                }

                // 5. ç¹ªè£½ç™½è‰²ç²‰ç­†åœ–æ¡ˆ (æ‰“å‹¾ + æ¸…å–®)
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                // 5a. å¤§æ‰“å‹¾ç¬¦è™Ÿ
                ctx.lineWidth = 35;
                ctx.beginPath();
                ctx.moveTo(130, 240);
                ctx.lineTo(210, 320);
                ctx.lineTo(360, 170);
                ctx.stroke();

                // 5b. æ¸…å–®æ©«ç·š (è±¡å¾µç®¡ç†é …ç›®)
                ctx.lineWidth = 15;
                // ç·šæ¢ 1
                ctx.beginPath();
                ctx.moveTo(240, 240);
                ctx.lineTo(380, 240);
                ctx.stroke();
                // ç·šæ¢ 2
                ctx.beginPath();
                ctx.moveTo(240, 290);
                ctx.lineTo(380, 290);
                ctx.stroke();

                // 6. åº•éƒ¨ç²‰ç­†æ§½ (è£é£¾ç´°ç¯€)
                ctx.fillStyle = '#6D4C41';
                ctx.fillRect(70, 380, 372, 20);
                // æ”¾ä¸€å°æˆªç™½è‰²ç²‰ç­†
                ctx.fillStyle = '#F0F0F0';
                ctx.fillRect(350, 382, 40, 16);

                var iconUrl = canvas.toDataURL('image/png');
                var iosIcon = document.getElementById('ios-icon');
                var favIcon = document.getElementById('fav-icon');
                if(iosIcon) iosIcon.href = iconUrl;
                if(favIcon) favIcon.href = iconUrl;
            } catch(e) {
                console.log("Icon generation failed, using default.");
            }
        };
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: #FEF9F2; margin: 0; padding: 0; overscroll-behavior-y: none; font-family: -apple-system, sans-serif; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #FEF9F2; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #5D4037; border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-log { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); color: red; padding: 20px; z-index: 10000; overflow: auto; font-family: monospace; font-size: 16px; white-space: pre-wrap; bottom: 0; border-top: 2px solid red; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
</head>
<body>
    <div id="error-log"></div>
    <div id="root">
        <div id="loading-screen">
            <div class="spinner"></div>
            <h2 style="color: #5D4037; font-weight: bold;">Pro+ ç³»çµ±å•Ÿå‹•ä¸­...</h2>
            <p style="color: #888; font-size: 12px; margin-top: 10px;">è‹¥å¡ä½è¶…é 10 ç§’ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</p>
        </div>
    </div>

    <script type="text/babel" data-presets="env,react">
        if (!window.React || !window.ReactDOM) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerText = "âš ï¸ åš´é‡éŒ¯èª¤ï¼šReact æ ¸å¿ƒè¼‰å…¥å¤±æ•—ã€‚\nè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸ï¼Œæˆ–é˜²ç«ç‰†æ˜¯å¦é˜»æ“‹äº† unpkg.comã€‚";
            throw new Error("React Load Failed");
        }

        const { useState, useEffect, useRef } = React;

        // --- SVG åœ–ç¤ºåº« ---
        const Icons = {
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            PackageX: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m7.5 4.27 9 5.15"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/><path d="m17 13 5 5m-5 0 5-5"/></svg>,
            MicOff: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            AlertCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            MessageCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            FileWarning: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            BookOpen: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Coffee: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            PenTool: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
            Stethoscope: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>,
            Briefcase: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Palmtree: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1 1 1h4"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1-1 1h-3"/><path d="M5.89 9.71c-2.15 2.15-2.3 5.47-.35 7.43l4.24-4.25.7-.7.71-.71 2.12-2.12c-1.95-1.96-5.27-1.8-7.42.35z"/><path d="M11 15.5c.5 2.5-.17 4.5-1 6.5h4c2-5.5-.5-12-1-14"/></svg>,
            HelpCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Star: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            User: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            CheckCircle2: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Edit3: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
            Trash2: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            ClipboardCopy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Download: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-.69 2.82l.14.23a2 2 0 0 1 0 2l-.14.23a2 2 0 0 0 .69 2.82l.45.26a2 2 0 0 0 2 0l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2 0l.45-.26a2 2 0 0 0 .69-2.82l-.14-.23a2 2 0 0 1 0-2l.14-.23a2 2 0 0 0-.69-2.82l-.45-.26a2 2 0 0 0-2 0l-.18.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            FileSpreadsheet: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            UserCog: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><circle cx="19" cy="11" r="2"/><path d="M19 8v1"/><path d="M19 13v1"/></svg>,
            Share: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>,
            MoreVertical: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
            LayoutGrid: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Info: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            AlertTriangle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Megaphone: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>,
            Send: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Printer: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Upload: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Camera: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            FileText: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Sparkles: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></svg>,
            Key: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            Trash: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            RefreshCw: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Save: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        };
        const Icon = ({ name, className = "" }) => { const IconComponent = Icons[name] || Icons['AlertCircle']; return <span className={className}><IconComponent /></span>; };

        // --- CSS (é¦¬å¡é¾ + 3DæŒ‰éˆ• + ZCOOL) ---
        const customStyles = `
          @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
          body { background-color: #FEF9F2; background-image: linear-gradient(#E8E8E8 1px, transparent 1px), linear-gradient(90deg, #E8E8E8 1px, transparent 1px); background-size: 20px 20px; font-family: 'ZCOOL KuaiLe', cursive, sans-serif; color: #5D4037; font-size: 18px; }
          .btn-3d { transition: all 0.1s; border: 3px solid #5D4037; box-shadow: 4px 4px 0px #5D4037; border-radius: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; font-size: 1.2rem; }
          .btn-3d:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #5D4037; }
          .nav-btn-settings { background-color: #FF5252; color: white; border: 3px solid #5D4037; box-shadow: 0px 4px 0px #3E2723; transform: translateY(-10px); z-index: 50; }
          .nav-btn-settings.active { background-color: #FF1744; transform: translateY(-16px) scale(1.1); box-shadow: 0px 6px 0px #3E2723; border: 3px solid #FFF; outline: 3px solid #5D4037; }
          .bg-mint { background-color: #CDF0EA; } .bg-yellow { background-color: #FDFD96; } .bg-pink { background-color: #FFC4C4; } .bg-blue-soft { background-color: #C4E4FF; } .bg-purple-soft { background-color: #E2C4FF; } .bg-orange-soft { background-color: #FFD8B1; } .bg-red-alert { background-color: #FF8A80; color: white; } .bg-line { background-color: #06C755; color: white; }
          .bg-coffee { background-color: #5D4037; color: white; }
          .text-coffee { color: #5D4037; } .border-coffee { border-color: #5D4037; }
          .doodle-card { background: white; border: 3px solid #5D4037; border-radius: 24px; box-shadow: 6px 6px 0px rgba(93, 64, 55, 0.2); }
          .input-hand { border: 3px solid #5D4037; border-radius: 12px; padding: 12px 16px; background: #FFF; font-family: 'ZCOOL KuaiLe', cursive; outline: none; width: 100%; font-size: 1.1rem; }
          .input-hand:focus { box-shadow: 3px 3px 0px #5D4037; }
          .marker-highlight { background: linear-gradient(120deg, #FDFD96 0%, #FDFD96 100%); background-repeat: no-repeat; background-size: 100% 40%; background-position: 0 80%; }
        `;

        const PERIODS = [
          { id: 'early', label: 'æ—©ä¿®' }, { id: 'p1', label: 'ç¬¬ä¸€ç¯€' }, { id: 'p2', label: 'ç¬¬äºŒç¯€' }, { id: 'p3', label: 'ç¬¬ä¸‰ç¯€' }, { id: 'p4', label: 'ç¬¬å››ç¯€' },
          { id: 'lunch', label: 'åˆé¤' }, { id: 'nap', label: 'åˆä¼‘' }, { id: 'p5', label: 'ç¬¬äº”ç¯€' }, { id: 'p6', label: 'ç¬¬å…­ç¯€' }, { id: 'p7', label: 'ç¬¬ä¸ƒç¯€' }, { id: 'p8', label: 'ç¬¬å…«ç¯€' },
        ];
        const DEFAULT_BEHAVIORS = [
          { id: 'item_missing', label: 'ç‰©å“æœªå¸¶', icon: 'PackageX', color: 'bg-pink' },
          { id: 'late_class', label: 'æ™šé€²æ•™å®¤', icon: 'Clock', color: 'bg-yellow' },
          { id: 'rude', label: 'å°å¸«ä¸ç¦®è²Œ', icon: 'MicOff', color: 'bg-pink' },
          { id: 'noise', label: 'åµé¬§å¹²æ“¾', icon: 'AlertCircle', color: 'bg-pink' },
          { id: 'chat', label: 'èŠå¤©', icon: 'MessageCircle', color: 'bg-yellow' },
          { id: 'note', label: 'å‚³ç´™æ¢', icon: 'FileWarning', color: 'bg-yellow' },
          { id: 'other_book', label: 'çœ‹èª²å¤–æ›¸', icon: 'BookOpen', color: 'bg-yellow' },
          { id: 'sleep', label: 'æ‰“çŒç¡', icon: 'Coffee', color: 'bg-pink' },
          { id: 'no_hw_cls', label: 'ä½œæ¥­æœªäº¤', icon: 'FileWarning', color: 'bg-pink' },
          { id: 'other', label: 'å…¶ä»–', icon: 'PenTool', color: 'bg-blue-soft' },
        ];
        const ATTENDANCE_TYPES = [
          { id: 'late', label: 'é²åˆ°', icon: 'Clock', color: 'bg-yellow' },
          { id: 'sick', label: 'ç—…å‡', icon: 'Stethoscope', color: 'bg-mint' },
          { id: 'official', label: 'å…¬å‡', icon: 'Briefcase', color: 'bg-blue-soft' },
          { id: 'personal', label: 'äº‹å‡', icon: 'Palmtree', color: 'bg-purple-soft' },
          { id: 'other_leave', label: 'å…¶ä»–', icon: 'HelpCircle', color: 'bg-gray-200' },
          { id: 'absent', label: 'ç¼ºå¸­', icon: 'AlertCircle', color: 'bg-pink' },
        ];
        // ä¿®æ”¹è™•ï¼šå°‡ã€Œè¯çµ¡ç°¿é²äº¤ã€æ”¹ç‚ºã€Œè¯çµ¡ç°¿ç¼ºäº¤ã€
        const CONTACT_BOOK_TYPES = [
          { id: 'cb_missing', label: 'è¯çµ¡ç°¿å®¶é•·æœªç°½å', icon: 'X', color: 'bg-pink' },
          { id: 'cb_late', label: 'è¯çµ¡ç°¿ç¼ºäº¤', icon: 'Clock', color: 'bg-yellow' },
          { id: 'cb_good', label: 'è¯çµ¡ç°¿å„ªè‰¯', icon: 'Star', color: 'bg-mint' },
        ];
        const DEFAULT_SUBJECTS = [
          { id: 'chinese', label: 'åœ‹æ–‡' }, { id: 'english', label: 'è‹±èª' }, { id: 'math', label: 'æ•¸å­¸' },
          { id: 'science', label: 'ç†åŒ–' }, { id: 'civics', label: 'å…¬æ°‘' }, { id: 'history', label: 'æ­·å²' }, { id: 'geo', label: 'åœ°ç†' },
        ];

        function ClassManagerLine() {
          const [activeTab, setActiveTab] = useState('basic'); 
          const [currentDate, setCurrentDate] = useState(() => {
            try { const now = new Date(); const utc = now.getTime() + (now.getTimezoneOffset() * 60000); const gmt8Time = new Date(utc + (3600000 * 8)); return gmt8Time.toISOString().split('T')[0]; } catch(e) { return new Date().toISOString().split('T')[0]; }
          });
          const [allData, setAllData] = useState(() => { try { const saved = localStorage.getItem('classLogDB_Line'); return saved ? JSON.parse(saved) : {}; } catch { return {}; } });

          const [week, setWeek] = useState('1'); 
          const [dutyStudent, setDutyStudent] = useState('1');
          const [attendanceData, setAttendanceData] = useState({});
          const [missingData, setMissingData] = useState({});
          const [classLogData, setClassLogData] = useState({});
          const [periodNotes, setPeriodNotes] = useState({}); 
          const [incidentLog, setIncidentLog] = useState('');
          const [attendanceNotes, setAttendanceNotes] = useState({}); 
          
          const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('geminiApiKey') || "");
          const [isAiProcessing, setIsAiProcessing] = useState(false);

          const [subjects, setSubjects] = useState(() => { try { const s = localStorage.getItem('classLogSubjects'); return s ? JSON.parse(s) : DEFAULT_SUBJECTS; } catch { return DEFAULT_SUBJECTS; } });
          const [behaviors, setBehaviors] = useState(() => { try { const b = localStorage.getItem('classLogBehaviors'); return b ? JSON.parse(b) : DEFAULT_BEHAVIORS; } catch { return DEFAULT_BEHAVIORS; } });
          const [students, setStudents] = useState(() => { try { const s = localStorage.getItem('classLogStudents'); return s ? JSON.parse(s) : Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}è™Ÿ` })); } catch { return Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}è™Ÿ` })); } });
          
          const [newSubjectName, setNewSubjectName] = useState('');
          const [isAddingSubject, setIsAddingSubject] = useState(false);
          const [newBehaviorName, setNewBehaviorName] = useState('');
          const [isEditingBehaviors, setIsEditingBehaviors] = useState(false);
          const [isSelectorOpen, setIsSelectorOpen] = useState(false);
          const [selectorConfig, setSelectorConfig] = useState({ type: '', category: '', period: '' });
          const [selectedStudentReport, setSelectedStudentReport] = useState(1);
          const [bulkNamesInput, setBulkNamesInput] = useState(''); 
          const [currentSubjectId, setCurrentSubjectId] = useState('');
          const [currentLogPeriod, setCurrentLogPeriod] = useState('p1');
          const [teacherNote, setTeacherNote] = useState(() => localStorage.getItem('classLogTeacherNote') || '');
          const [isProcessing, setIsProcessing] = useState(false);
          const fileInputRef = useRef(null);
          const backupInputRef = useRef(null);

          useEffect(() => {
            const dayData = allData[currentDate] || {};
            setWeek(dayData.week || '1');
            setDutyStudent(dayData.dutyStudent || '1');
            setAttendanceData(dayData.attendanceData || {});
            setMissingData(dayData.missingData || {});
            setClassLogData(dayData.classLogData || {});
            setPeriodNotes(dayData.periodNotes || {});
            setIncidentLog(dayData.incidentLog || '');
            setAttendanceNotes(dayData.attendanceNotes || {}); 
          }, [currentDate, allData]); 

          useEffect(() => {
            const timer = setTimeout(() => {
              setAllData(prev => ({ ...prev, [currentDate]: { week, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog, attendanceNotes } }));
              localStorage.setItem('classLogDB_Line', JSON.stringify({ ...allData, [currentDate]: { week, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog, attendanceNotes } }));
            }, 500);
            return () => clearTimeout(timer);
          }, [week, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog, attendanceNotes, currentDate]);

          useEffect(() => {
            localStorage.setItem('classLogSubjects', JSON.stringify(subjects));
            localStorage.setItem('classLogBehaviors', JSON.stringify(behaviors));
            localStorage.setItem('classLogStudents', JSON.stringify(students));
          }, [subjects, behaviors, students]);

          useEffect(() => { localStorage.setItem('classLogTeacherNote', teacherNote); }, [teacherNote]);
          useEffect(() => { if (subjects.length > 0 && !currentSubjectId) setCurrentSubjectId(subjects[0].id); }, [subjects, currentSubjectId]);
          useEffect(() => { localStorage.setItem('geminiApiKey', userApiKey); }, [userApiKey]);

          // --- æ ¸å¿ƒé‚è¼¯å‡ç´šï¼šå–å¾—æ¯é€±è©³ç´°æ¸…å–® ---
          const getWeeklyStats = (studentId) => {
            const dates = []; const today = new Date(currentDate); 
            for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); }
            
            let stats = { attendance: {}, missing: {}, behavior: {} }; 
            let attendanceDetails = [];
            let missingDetails = [];
            let behaviorDetails = [];

            dates.forEach(date => {
              const data = allData[date]; if (!data) return;
              const dateStr = date.slice(5).replace('-','/'); // æ ¼å¼ MM/DD
              
              // 1. ç¼ºå‹¤è©³ç´°
              if (data.attendanceData) {
                  Object.keys(data.attendanceData).forEach(k => { 
                      if (data.attendanceData[k]?.includes(studentId)) {
                          stats.attendance[k] = (stats.attendance[k] || 0) + 1;
                          const label = ATTENDANCE_TYPES.find(t=>t.id===k)?.label || k;
                          attendanceDetails.push(`${dateStr} ${label}`);
                      } 
                  });
              }

              // 2. ç¼ºäº¤è©³ç´°
              if (data.missingData) {
                  Object.keys(data.missingData).forEach(k => { 
                      if (data.missingData[k]?.includes(studentId)) { 
                          let label = k; 
                          const sub = subjects.find(s => s.id === k); 
                          const cb = CONTACT_BOOK_TYPES.find(c => c.id === k); 
                          if (sub) label = sub.label + 'ä½œæ¥­'; 
                          if (cb) label = cb.label; 
                          stats.missing[label] = (stats.missing[label] || 0) + 1; 
                          missingDetails.push(`${dateStr} ${label}`);
                      } 
                  });
              }

              // 3. é•è¦è©³ç´°
              if (data.classLogData) {
                  Object.keys(data.classLogData).forEach(periodId => { 
                      const pLog = data.classLogData[periodId]; 
                      if (pLog) { 
                          Object.keys(pLog).forEach(bId => { 
                              if (pLog[bId]?.includes(studentId)) { 
                                  const b = behaviors.find(be => be.id === bId); 
                                  const label = b ? b.label : 'å…¶ä»–'; 
                                  const periodLabel = PERIODS.find(p => p.id === periodId)?.label || periodId; 
                                  stats.behavior[label] = (stats.behavior[label] || 0) + 1; 
                                  behaviorDetails.push(`${dateStr} ${periodLabel}ï¼š${label}`); 
                              } 
                          }); 
                      } 
                  });
              }
            });
            // è®“æ—¥æœŸç”±èˆŠåˆ°æ–°æ’åˆ— (reverse å› ç‚º dates è¿´åœˆæ˜¯å¾ä»Šå¤©å¾€å‰æ¨)
            return { 
                dates, 
                stats, 
                attendanceDetails: attendanceDetails.reverse(),
                missingDetails: missingDetails.reverse(),
                behaviorDetails: behaviorDetails.reverse() 
            };
          };

          // --- ç”Ÿæˆè¤‡è£½ç”¨çš„æ–‡å­—è¨Šæ¯ ---
          const generateParentMessage = (studentId) => { 
            const s = students.find(stud => stud.id === studentId); 
            if (!s) return "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ..."; 
            const { dates, stats, attendanceDetails, missingDetails, behaviorDetails } = getWeeklyStats(studentId); 
            const dateRange = `${dates[dates.length-1].slice(5).replace('-','/')} ~ ${dates[0].slice(5).replace('-','/')}`; 
            
            let msg = ""; 
            if (teacherNote.trim()) msg += `ã€è€å¸«çš„è©±ã€‘\n${teacherNote}\n\n`; 
            
            msg += `è¦ªæ„›çš„ ${s.name} å®¶é•·æ‚¨å¥½ï¼Œé€™æ˜¯æœ¬é€± (${dateRange}) çš„åœ¨æ ¡è¡¨ç¾æ‘˜è¦ï¼š\n\n`; 
            
            // ç¼ºå‹¤
            const totalAtt = Object.values(stats.attendance).reduce((a,b)=>a+b,0);
            if (totalAtt === 0) {
                msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼šå…¨å‹¤ ğŸ‘\n`;
            } else {
                msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ (${totalAtt}æ¬¡)ï¼š\n`;
                attendanceDetails.forEach(d => msg += `   - ${d}\n`);
            }
            
            // ç¼ºäº¤
            const totalMiss = Object.values(stats.missing).reduce((a,b)=>a+b,0);
            if (totalMiss === 0) {
                msg += `ğŸ“š ä½œæ¥­ç¹³äº¤ï¼šç‹€æ³è‰¯å¥½ ğŸ‘\n`; 
            } else {
                msg += `ğŸ“š ä½œæ¥­ç¼ºäº¤ (${totalMiss}é …)ï¼š\n`;
                missingDetails.forEach(d => msg += `   - ${d}\n`);
            }

            // é•è¦
            const totalBeh = Object.values(stats.behavior).reduce((a,b)=>a+b,0);
            if (totalBeh === 0) {
                msg += `âœ¨ èª²å ‚è¡¨ç¾ï¼šéµå®ˆå¸¸è¦ï¼Œè¡¨ç¾ç©©å®šã€‚\n`; 
            } else {
                msg += `âš ï¸ èª²å ‚å¸¸è¦æé†’ (${totalBeh}æ¬¡)ï¼š\n`; 
                behaviorDetails.forEach(item => { msg += `   - ${item}\n`; }); 
            }
            
            msg += `\nå†è«‹æ‚¨å”åŠ©é—œå¿ƒå­©å­çš„å­¸ç¿’ç‹€æ³ï¼Œè¬è¬æ‚¨çš„é…åˆï¼`; 
            return msg; 
          };

          // --- åˆ—å°å…¨ç­é€±å ± (å®¶é•·ä¿¡æ ¼å¼ + è‡ªå‹•æ’ç‰ˆ) ---
          const handlePrintAllStudents = () => {
            const printWindow = window.open('', '', 'width=800,height=600');
            let html = '<html><head><title>å…¨ç­å€‹åˆ¥é€±å ±è¡¨</title>';
            html += '<style>';
            html += 'body { font-family: "Microsoft JhengHei", sans-serif; padding: 10px; }';
            // ä½¿ç”¨ Masonry ç€‘å¸ƒæµæ’ç‰ˆ (column-count)
            html += '.container { column-count: 2; column-gap: 15px; }'; 
            html += '.card { break-inside: avoid; margin-bottom: 15px; border: 2px solid #5D4037; border-radius: 8px; padding: 15px; box-sizing: border-box; background: #fff; }';
            html += '.teacher-note-block { border-bottom: 2px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px; }';
            html += '.teacher-note-title { font-weight: bold; text-decoration: underline; font-size: 1.1em; margin-bottom: 5px; }';
            html += '.header { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }';
            html += '.range { font-size: 0.8em; color: #666; margin-bottom: 10px; }';
            html += '.section { margin-top: 8px; }';
            html += '.section-title { font-weight: bold; font-size: 0.95em; background: #eee; padding: 2px 5px; border-radius: 3px; display: inline-block; margin-bottom: 3px; }';
            html += '.detail-list { font-size: 0.9em; margin: 0; padding-left: 20px; line-height: 1.4; }';
            html += '.good-msg { color: #2e7d32; font-size: 0.9em; font-style: italic; }';
            html += '.footer { margin-top: 15px; border-top: 1px solid #eee; padding-top: 5px; font-size: 0.8em; text-align: right; }';
            html += '@media print { body { background: none; } }';
            html += '</style></head><body><div class="container">';

            students.forEach(student => {
                const { dates, stats, attendanceDetails, missingDetails, behaviorDetails } = getWeeklyStats(student.id);
                const dateRange = `${dates[dates.length-1].slice(5).replace('-','/')} ~ ${dates[0].slice(5).replace('-','/')}`;
                const totalAtt = Object.values(stats.attendance).reduce((a,b) => a+b, 0);
                const totalMiss = Object.values(stats.missing).reduce((a,b) => a+b, 0);
                const totalBeh = Object.values(stats.behavior).reduce((a,b) => a+b, 0);

                html += `<div class="card">
                    <div class="teacher-note-block">
                        <div class="teacher-note-title">ğŸ“¢ è€å¸«çš„è©±ï¼š</div>
                        <div>${teacherNote || 'ç„¡'}</div>
                    </div>

                    <div class="header">è¦ªæ„›çš„ ${student.name} å®¶é•·æ‚¨å¥½ï¼š</div>
                    <div class="range">æœ¬é€±çµ±è¨ˆç¯„åœï¼š${dateRange}</div>
                    
                    <div class="section">
                        <div class="section-title">âš ï¸ é•è¦è¡Œç‚º (å…±${totalBeh}æ¬¡)</div>
                        ${totalBeh > 0 
                            ? `<ul class="detail-list">${behaviorDetails.map(d => `<li>${d}</li>`).join('')}</ul>`
                            : `<div class="good-msg">âœ¨ è¡¨ç¾ç©©å®šï¼Œéµå®ˆå¸¸è¦ã€‚</div>`
                        }
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ“š ç¼ºäº¤ä½œæ¥­ (å…±${totalMiss}é …)</div>
                        ${totalMiss > 0 
                            ? `<ul class="detail-list">${missingDetails.map(d => `<li>${d}</li>`).join('')}</ul>`
                            : `<div class="good-msg">ğŸ‘ ä½œæ¥­ç¹³äº¤ç‹€æ³è‰¯å¥½ã€‚</div>`
                        }
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ“… ç¼ºå‹¤ç´€éŒ„ (å…±${totalAtt}æ¬¡)</div>
                        ${totalAtt > 0 
                            ? `<ul class="detail-list">${attendanceDetails.map(d => `<li>${d}</li>`).join('')}</ul>`
                            : `<div class="good-msg">ğŸ‘ å…¨å‹¤ã€‚</div>`
                        }
                    </div>

                    <div class="footer">å®¶é•·ç°½åï¼š________________</div>
                </div>`;
            });

            html += '</div></body></html>';
            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); }, 500);
          };

          // ... (ä»¥ä¸‹ç‚ºå…¶é¤˜ä»‹é¢åŠŸèƒ½) ...
          const processFile = (file) => { setIsProcessing(true); const reader = new FileReader(); const fileName = file.name.toLowerCase(); if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) { reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1}); let names = []; jsonData.forEach(row => { if(row[0] && typeof row[0] === 'string') names.push(row[0]); }); if(names.length > 0) { setBulkNamesInput(names.join('\n')); alert(`å·²å¾ Excel è®€å– ${names.length} ç­†è³‡æ–™ï¼Œè«‹ç¢ºèªå¾ŒæŒ‰ã€ŒåŒ¯å…¥ã€ã€‚`); } else { alert('Excel ä¸­æ‰¾ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªåå­—åœ¨ç¬¬ä¸€æ¬„ã€‚'); } } catch(err) { alert('Excel è§£æå¤±æ•—ï¼š' + err); } setIsProcessing(false); }; reader.readAsArrayBuffer(file); } else if (fileName.endsWith('.docx')) { reader.onload = (e) => { mammoth.extractRawText({arrayBuffer: e.target.result}) .then(result => { const text = result.value; const cleanText = text.split('\n').map(l=>l.trim()).filter(l=>l).join('\n'); setBulkNamesInput(cleanText); alert('å·²è®€å– Word æ–‡å­—ï¼Œè«‹ç¢ºèªã€‚'); setIsProcessing(false); }) .catch(err => { alert('Word è§£æå¤±æ•—ï¼š' + err); setIsProcessing(false); }); }; reader.readAsArrayBuffer(file); } else if (file.type.startsWith('image/')) { Tesseract.recognize( file, 'chi_tra', { logger: m => console.log(m) } ).then(({ data: { text } }) => { const cleanText = text.split(/\s+/).filter(s => s.length >= 2).join('\n'); setBulkNamesInput(cleanText); alert('åœ–ç‰‡è¾¨è­˜å®Œæˆï¼OCR å¯èƒ½æœ‰éŒ¯å­—ï¼Œè«‹å‹™å¿…æª¢æŸ¥ã€‚'); setIsProcessing(false); }).catch(err => { alert('åœ–ç‰‡è¾¨è­˜å¤±æ•—ï¼š' + err); setIsProcessing(false); }); } else { alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚è«‹ä½¿ç”¨ Excel, Word æˆ– åœ–ç‰‡ã€‚'); setIsProcessing(false); } };
          const handleBulkImportNames = () => { if (!bulkNamesInput.trim()) return; const names = bulkNamesInput.split(/\n/).map(n => n.trim()).filter(n => n); if (confirm(`å³å°‡åŒ¯å…¥ ${names.length} ä½å­¸ç”Ÿï¼Œç¢ºå®šå—ï¼Ÿ`)) { setStudents(names.map((name, index) => ({ id: index + 1, name: name }))); setBulkNamesInput(''); alert('åŒ¯å…¥æˆåŠŸï¼'); } };
          const handleAddSubject = () => { if (newSubjectName.trim()) { const newId = `sub_${Date.now()}`; setSubjects([...subjects, { id: newId, label: newSubjectName.trim() }]); setNewSubjectName(''); setIsAddingSubject(false); setCurrentSubjectId(newId); } else { alert("è«‹è¼¸å…¥ç§‘ç›®åç¨±"); } };
          const handleDeleteSubject = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç§‘ç›®ï¼Ÿ')) setSubjects(subjects.filter(s => s.id !== id)); };
          const handleAddBehavior = () => { if (newBehaviorName.trim()) { setBehaviors([...behaviors, { id: `beh_${Date.now()}`, label: newBehaviorName.trim(), icon: 'AlertCircle', color: 'bg-yellow' }]); setNewBehaviorName(''); } else { alert("è«‹è¼¸å…¥é•è¦é …ç›®åç¨±"); } };
          const handleDeleteBehavior = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) setBehaviors(behaviors.filter(b => b.id !== id)); };
          const handleAttendanceClick = (typeId) => { if (typeId === 'other_leave') { const currentNote = attendanceNotes['other_leave'] || ""; const note = prompt("è«‹è¼¸å…¥ã€Œå…¶ä»–ã€ç¼ºå¸­çš„åŸå›  (ä¾‹å¦‚ï¼šäº‹å‡ã€å–ªå‡)ï¼š", currentNote); if (note !== null) { setAttendanceNotes(prev => ({ ...prev, 'other_leave': note })); openSelector('attendance', typeId); } } else { openSelector('attendance', typeId); } };
          const handleBehaviorClick = (behaviorId) => { if (isEditingBehaviors) return; if (behaviorId === 'other') { const currentNote = periodNotes[currentLogPeriod] || ''; const note = prompt(`è«‹è¼¸å…¥ ${PERIODS.find(p=>p.id===currentLogPeriod)?.label} çš„å…¶ä»–èªªæ˜ï¼š`, currentNote); if (note !== null) { updatePeriodNote(note); openSelector('log', behaviorId, currentLogPeriod); } } else { openSelector('log', behaviorId, currentLogPeriod); } };
          const openSelector = (type, category, period = null) => { setSelectorConfig({ type, category, period }); setIsSelectorOpen(true); };
          const toggleStudent = (studentId) => { const { type, category, period } = selectorConfig; if (type === 'attendance') setAttendanceData(prev => { const list = prev[category] || []; return { ...prev, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] }; }); else if (type === 'missing') setMissingData(prev => { const list = prev[category] || []; return { ...prev, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] }; }); else if (type === 'log') setClassLogData(prev => { const out = prev[period] || {}; const list = out[category] || []; return { ...prev, [period]: { ...out, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] } }; }); };
          const getSelectedStudents = () => { const { type, category, period } = selectorConfig; if (type === 'attendance') return attendanceData[category] || []; if (type === 'missing') return missingData[category] || []; if (type === 'log') return classLogData[period]?.[category] || []; return []; };
          const updatePeriodNote = (val) => setPeriodNotes(prev => ({ ...prev, [currentLogPeriod]: val }));
          const downloadCSV = (content, filename) => { const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' })); link.download = filename; link.click(); };
          const getDailyStudentViolations = () => { const studentViolations = {}; PERIODS.forEach(p => { const logs = classLogData[p.id]; if (!logs) return; behaviors.forEach(b => { const list = logs[b.id]; if (list && list.length > 0) list.forEach(studentId => { if (!studentViolations[studentId]) studentViolations[studentId] = []; studentViolations[studentId].push(`${p.label}: ${b.label}`); }); }); }); return studentViolations; };
          const exportDailyLog = () => { let csv = `ç­ç´šæ—¥èªŒ,æ—¥æœŸï¼š${currentDate},é€±æ¬¡ï¼š${week},å€¼æ—¥ç”Ÿï¼š${dutyStudent}\n\nã€åˆ°æ ¡ã€‘\né¡åˆ¥,å­¸ç”Ÿ\n`; ATTENDANCE_TYPES.forEach(t => { const list = attendanceData[t.id]?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; if(list) csv += `${t.label},"${list}"\n`; }); csv += `\nã€ä½œæ¥­ã€‘\né …ç›®,ç¼ºäº¤\n`; const getMissingNames = (list) => list?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; CONTACT_BOOK_TYPES.forEach(t => { const str = getMissingNames(missingData[t.id]); if(str) csv += `${t.label},"${str}"\n`; }); subjects.forEach(s => { const str = getMissingNames(missingData[s.id]); if(str) csv += `${s.label}ç¼ºäº¤,"${str}"\n`; }); csv += `\nã€èª²å ‚ã€‘\næ™‚æ®µ,è¡Œç‚º,å­¸ç”Ÿ,å‚™è¨»\n`; PERIODS.forEach(p => { const logs = classLogData[p.id]; const note = periodNotes[p.id] || ''; if (logs) behaviors.forEach(b => { const rawList = logs[b.id]; if (rawList && rawList.length > 0) { const names = rawList.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€'); csv += `${p.label},${b.label},"${names}","${note}"\n`; } }); if ((!logs || Object.keys(logs).every(k => logs[k].length === 0)) && note) csv += `${p.label},å‚™è¨»,,"${note}"\n`; }); csv += `\nã€å¶ç™¼ã€‘\n"${incidentLog.replace(/"/g, '""')}"\n`; downloadCSV(csv, `ç­ç´šæ—¥èªŒ_${currentDate}.csv`); };
          const exportWholeClassWeekly = () => { const dates = []; const today = new Date(currentDate); for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); } let csv = `å…¨ç­é€±å ±è¡¨\nçµ±è¨ˆç¯„åœ,${dates[dates.length-1]} ~ ${dates[0]}\n\nåº§è™Ÿ,å§“å,ç¼ºå‹¤ç¸½æ•¸,ç¼ºäº¤ç¸½æ•¸,é•è¦ç¸½æ•¸,ç¼ºå‹¤æ˜ç´°,ç¼ºäº¤æ˜ç´°,é•è¦æ˜ç´°\n`; students.forEach(student => { const { stats } = getWeeklyStats(student.id); const totalAtt = Object.values(stats.attendance).reduce((a,b) => a+b, 0); const totalMiss = Object.values(stats.missing).reduce((a,b) => a+b, 0); const totalBeh = Object.values(stats.behavior).reduce((a,b) => a+b, 0); const strAtt = Object.entries(stats.attendance).map(([k,v]) => { const t = ATTENDANCE_TYPES.find(x => x.id === k); return `${t?.label || k}(${v})`; }).join('ã€'); const strMiss = Object.entries(stats.missing).map(([k,v]) => `${k}(${v})`).join('ã€'); const strBeh = Object.entries(stats.behavior).map(([k,v]) => `${k}(${v})`).join('ã€'); csv += `${student.id},${student.name},${totalAtt},${totalMiss},${totalBeh},"${strAtt}","${strMiss}","${strBeh}"\n`; }); downloadCSV(csv, `å…¨ç­é€±å ±è¡¨_${currentDate}.csv`); };
          const handleResetData = () => { if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰€æœ‰æ­·å²è³‡æ–™ï¼\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚\n\nç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) { localStorage.removeItem('classLogDB_Line'); localStorage.removeItem('classLogTeacherNote'); alert("è³‡æ–™å·²é‡ç½®ï¼"); window.location.reload(); } };
          const handleBackupData = () => { const data = { version: "2.0", timestamp: new Date().toISOString(), classLogDB: JSON.parse(localStorage.getItem('classLogDB_Line') || '{}'), subjects: JSON.parse(localStorage.getItem('classLogSubjects') || '[]'), behaviors: JSON.parse(localStorage.getItem('classLogBehaviors') || '[]'), students: JSON.parse(localStorage.getItem('classLogStudents') || '[]'), teacherNote: localStorage.getItem('classLogTeacherNote') || '' }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ç­ç´šå°ç®¡å®¶å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
          const handleRestoreData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.classLogDB) localStorage.setItem('classLogDB_Line', JSON.stringify(data.classLogDB)); if (data.subjects) localStorage.setItem('classLogSubjects', JSON.stringify(data.subjects)); if (data.behaviors) localStorage.setItem('classLogBehaviors', JSON.stringify(data.behaviors)); if (data.students) localStorage.setItem('classLogStudents', JSON.stringify(data.students)); if (data.teacherNote) localStorage.setItem('classLogTeacherNote', data.teacherNote); alert("è³‡æ–™é‚„åŸæˆåŠŸï¼ç¶²é å³å°‡é‡æ–°æ•´ç†ã€‚"); window.location.reload(); } catch (err) { alert("é‚„åŸå¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); };
          const exportStudentWeekly = () => { const s = students.find(s => s.id === selectedStudentReport); if(!s) return alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿ'); const { dates, stats } = getWeeklyStats(selectedStudentReport); let csv = `å­¸ç”Ÿå€‹åˆ¥é€±å ±è¡¨\nåº§è™Ÿ,${s.id}\nå§“å,${s.name}\nçµ±è¨ˆç¯„åœ,${dates[dates.length-1]} ~ ${dates[0]}\n\né¡åˆ¥,é …ç›®,æ¬¡æ•¸\n`; Object.entries(stats.attendance).forEach(([k, v]) => csv += `ç¼ºå‹¤,${ATTENDANCE_TYPES.find(t=>t.id===k)?.label||k},${v}\n`); Object.entries(stats.missing).forEach(([k, v]) => csv += `ç¼ºäº¤,${k},${v}\n`); Object.entries(stats.behavior).forEach(([k, v]) => csv += `é•è¦,${k},${v}\n`); downloadCSV(csv, `${s.name}_é€±å ±è¡¨.csv`); };
          const handleLineShare = (text) => window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
          const copyToClipboard = (text) => navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½è¨Šæ¯ï¼è«‹ç›´æ¥è²¼ä¸Šã€‚'));
          const callGemini = async (prompt) => { if (!userApiKey) { alert("è«‹å…ˆåœ¨ã€è¨­å®šã€‘é é¢è¼¸å…¥ Gemini API Key å–”ï¼"); return null; } setIsAiProcessing(true); try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); const data = await response.json(); setIsAiProcessing(false); if (data.error) { alert("API éŒ¯èª¤: " + data.error.message); return null; } return data.candidates[0].content.parts[0].text; } catch (error) { setIsAiProcessing(false); alert("é€£ç·šå¤±æ•—: " + error.message); return null; } };
          const handleAiGenerateReport = async () => { const student = students.find(s => s.id === selectedStudentReport); if (!student) return; const { stats, behaviorDetails } = getWeeklyStats(selectedStudentReport); const prompt = `ä½ æ˜¯ä¸€ä½å……æ»¿æ„›å¿ƒèˆ‡æ™ºæ…§çš„åœ‹ä¸­ç­å°å¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹å­¸ç”Ÿæœ¬é€±çš„åœ¨æ ¡æ•¸æ“šï¼Œå¯«ä¸€æ®µçµ¦å®¶é•·çš„é€±å ±è¨Šæ¯ï¼ˆç´„ 150 å­—ï¼‰ã€‚\nå­¸ç”Ÿå§“åï¼š${student.name}\næ—¥æœŸç¯„åœï¼šæœ¬é€±\nç¼ºå‹¤ç´€éŒ„ï¼š${Object.entries(stats.attendance).map(([k,v]) => `${k} ${v}æ¬¡`).join(', ') || 'å…¨å‹¤'}\nç¼ºäº¤ä½œæ¥­ï¼š${Object.entries(stats.missing).map(([k,v]) => `${k} ${v}æ¬¡`).join(', ') || 'ç„¡ç¼ºäº¤'}\né•è¦è¡Œç‚ºï¼š${Object.entries(stats.behavior).map(([k,v]) => `${k} ${v}æ¬¡`).join(', ') || 'è¡¨ç¾è‰¯å¥½'}\nè©³ç´°é•è¦ï¼š${behaviorDetails.join('; ')}\nè€å¸«çš„è©±ï¼š${teacherNote}\n\nå¯«ä½œæŒ‡å¼•ï¼š\n1. èªæ°£è¦ªåˆ‡ã€æ­£å‘é¼“å‹µï¼Œä½†ä¹Ÿè¦å®¢è§€é™³è¿°äº‹å¯¦ã€‚\n2. å¦‚æœè¡¨ç¾å¥½ï¼Œè«‹å¤šåŠ è®šç¾ï¼›å¦‚æœæœ‰é•è¦æˆ–ç¼ºäº¤ï¼Œè«‹å§”å©‰æå‡ºä¸¦è«‹å®¶é•·å”åŠ©ç£ä¿ƒã€‚\n3. è«‹ä»¥ã€Œè¦ªæ„›çš„ ${student.name} å®¶é•·æ‚¨å¥½ï¼šã€é–‹é ­ã€‚\n4. ä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ï¼Œç›´æ¥è¼¸å‡ºç´”æ–‡å­—ã€‚`; const result = await callGemini(prompt); if (result) { setAiReportMsg(result); } };
          const [aiReportMsg, setAiReportMsg] = useState(""); useEffect(() => { setAiReportMsg(""); }, [selectedStudentReport]);
          const handleAiPolishLog = async () => { if (!incidentLog.trim()) { alert("è«‹å…ˆè¼¸å…¥ä¸€äº›ç´€éŒ„å…§å®¹å–”ï¼"); return; } const prompt = `è«‹æ‰®æ¼”ä¸€ä½è³‡æ·±æ•™è‚²è¡Œæ”¿äººå“¡ã€‚å°‡ä»¥ä¸‹é€™æ®µè€å¸«éš¨æ‰‹å¯«çš„ã€Œç­ç´šå¶ç™¼äº‹ä»¶ç´€éŒ„ã€ï¼Œæ”¹å¯«ç‚ºä¸€ç¯‡ã€Œæ­£å¼ã€å®¢è§€ã€æ¢ç†åˆ†æ˜ã€çš„è¡Œæ”¿å ±å‘Šæ ¼å¼ã€‚\n\nåŸå§‹ç´€éŒ„ï¼š\n${incidentLog}\n\næ”¹å¯«è¦æ±‚ï¼š\n1. ä½¿ç”¨æ­£å¼å…¬æ–‡æˆ–å ±å‘Šèªæ°£ã€‚\n2. ä¿ç•™æ‰€æœ‰é—œéµäººåèˆ‡äº‹ä»¶ç¶“éï¼Œä¸è¦æœæ’°äº‹å¯¦ã€‚\n3. åˆ†é»æ•˜è¿°ï¼ˆå¦‚ï¼šä¸€ã€äº‹ä»¶ç¶“éï¼›äºŒã€è™•ç†æ–¹å¼ï¼›ä¸‰ã€å¾ŒçºŒè¼”å°ï¼‰ã€‚\n4. ä¸è¦ä½¿ç”¨ Markdownã€‚`; const result = await callGemini(prompt); if (result) { if(confirm("AI æ”¹å¯«å®Œæˆï¼æ˜¯å¦è¦æ›¿æ›ç›®å‰çš„å…§å®¹ï¼Ÿ\n\n" + result.substring(0, 100) + "...")) { setIncidentLog(result); } } };

          const StudentSelector = () => { if (!isSelectorOpen) return null; const selected = getSelectedStudents(); const { type, category, period } = selectorConfig; let title = ''; if (type === 'attendance') title = ATTENDANCE_TYPES.find(t => t.id === category)?.label || 'é»å'; if (type === 'missing') { const cbItem = CONTACT_BOOK_TYPES.find(t => t.id === category); const subjectItem = subjects.find(s => s.id === category); title = cbItem ? cbItem.label : (subjectItem ? `${subjectItem.label}ç¼ºäº¤` : 'é …ç›®'); } if (type === 'log') { const pName = PERIODS.find(p => p.id === period)?.label || period; const bName = behaviors.find(b => b.id === category)?.label || 'ç´€éŒ„'; title = `${pName} - ${bName}`; } return ( <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"> <div className="bg-[#FEF9F2] w-full max-w-sm rounded-2xl border-4 border-coffee shadow-2xl overflow-hidden flex flex-col max-h-[85vh]"> <div className="bg-yellow p-4 border-b-4 border-coffee flex justify-between items-center"> <h3 className="text-2xl font-bold text-coffee">é»é¸å­¸ç”Ÿ</h3> <button onClick={() => setIsSelectorOpen(false)} className="bg-white p-2 rounded-full border-2 border-coffee"><Icon name="CheckCircle2" className="w-8 h-8" /></button> </div> <div className="bg-yellow px-4 pb-2 text-coffee font-bold opacity-80 border-b-2 border-coffee mb-2">æ­£åœ¨ç™»è¨˜ï¼š{title}</div> <div className="p-4 overflow-y-auto grid grid-cols-4 gap-3"> {students.map(s => ( <button key={s.id} onClick={() => toggleStudent(s.id)} className={`p-2 rounded-xl border-2 border-coffee font-bold text-base flex flex-col items-center justify-center transition-all min-h-[70px] ${selected.includes(s.id) ? 'bg-coffee text-white transform scale-105 shadow-lg' : 'bg-white text-coffee hover:bg-gray-100'}`}> <span className="text-sm opacity-70 mb-1">#{s.id}</span> <span className="truncate w-full text-center text-lg">{s.name}</span> </button> ))} </div> <div className="p-4 bg-white border-t-4 border-coffee text-center"><button onClick={() => setIsSelectorOpen(false)} className="btn-3d w-full bg-mint py-4 text-2xl">å®Œ æˆ</button></div> </div> </div> ); };
          const renderManual = () => ( <div className="pb-24 space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300"> <div className="doodle-card p-5 bg-orange-soft"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2 border-b-2 border-coffee pb-2"><Icon name="Download" className="w-7 h-7"/> å¦‚ä½•å®‰è£ (åŠ å…¥ä¸»ç•«é¢)</h3><p className="mb-4 font-bold text-coffee opacity-80">å‹™å¿…å°‡æ­¤ç¶²é ã€åŠ å…¥ä¸»ç•«é¢ã€‘ï¼Œå³å¯åƒ App ä¸€æ¨£å…¨è¢å¹•ä½¿ç”¨ï¼Œä¸”è³‡æ–™æ›´å®‰å…¨ï¼</p><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="bg-white p-4 rounded-xl border-2 border-dashed border-coffee"><h4 className="font-bold text-xl mb-2 flex items-center gap-2"><Icon name="Share" className="w-5 h-5"/> iPhone (Safari)</h4><ol className="list-decimal pl-5 space-y-1"><li>é»é¸ä¸‹æ–¹é¸å–®ä¸­é–“çš„ã€Œåˆ†äº«ã€åœ–ç¤ºã€‚</li><li>å¾€ä¸‹æ»‘å‹•é¸å–®ã€‚</li><li>é¸æ“‡ <span className="marker-highlight px-1">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span>ã€‚</li></ol></div><div className="bg-white p-4 rounded-xl border-2 border-dashed border-coffee"><h4 className="font-bold text-xl mb-2 flex items-center gap-2"><Icon name="MoreVertical" className="w-5 h-5"/> Android (Chrome)</h4><ol className="list-decimal pl-5 space-y-1"><li>é»é¸å³ä¸Šè§’çš„ã€Œä¸‰å€‹é»ã€é¸å–®ã€‚</li><li>é¸æ“‡ <span className="marker-highlight px-1">ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€</span>ã€‚</li></ol></div></div></div> <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-2"><Icon name="LayoutGrid" className="w-7 h-7"/> åŠŸèƒ½å°è¦½</h3><div className="space-y-4">{[{icon: 'UserCog', label: 'è¨­å®š', desc: 'ç¬¬ä¸€æ¬¡è«‹å…ˆä¾†é€™ï¼åŒ¯å…¥å­¸ç”Ÿåå–®ã€ç®¡ç†ç§‘ç›®ã€‚', color: 'bg-red-alert'}, {icon: 'User', label: 'é»å', desc: 'æ¯æ—¥ä¾‹è¡Œã€‚ç´€éŒ„é²åˆ°ã€è«‹å‡ã€ä½œæ¥­ç¼ºäº¤ã€‚', color: 'bg-mint'}, {icon: 'Edit3', label: 'ç´€éŒ„', desc: 'èª²å ‚é•è¦è¿½è¹¤ã€‚ä½¿ç”¨é¸å–®åˆ‡æ›ç¯€æ¬¡ï¼Œå¿«é€Ÿç™»è¨˜ã€‚', color: 'bg-yellow'}, {icon: 'List', label: 'æ—¥èªŒ', desc: 'è‡ªå‹•å½™æ•´ä»Šæ—¥ç´€éŒ„ï¼Œå¯åŒ¯å‡ºä»Šæ—¥ Excelã€‚', color: 'bg-pink'}, {icon: 'FileSpreadsheet', label: 'å ±è¡¨', desc: 'ä¸‹è¼‰ã€å…¨ç­é€±å ±è¡¨ã€‘èˆ‡ç”¢ç”Ÿã€å€‹åˆ¥å®¶é•·é€šçŸ¥ã€‘ã€‚', color: 'bg-blue-soft'}].map((item, idx) => (<div key={idx} className="flex items-start gap-3"><div className={`w-12 h-12 rounded-full ${item.color} flex items-center justify-center shrink-0 border-2 border-coffee`}><div className="text-white"><Icon name={item.icon} className="w-6 h-6"/></div></div><div><h4 className="font-bold text-xl">{item.label}</h4><p className="text-base opacity-70 leading-snug">{item.desc}</p></div></div>))}</div></div> <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2 border-b-2 border-coffee pb-2"><Icon name="Info" className="w-7 h-7"/> å¸¸è¦‹å•é¡Œ</h3><ul className="list-disc pl-5 space-y-3"><li><span className="font-bold">è³‡æ–™å­˜åœ¨å“ªï¼Ÿ</span><br/>å­˜åœ¨æ‰‹æ©Ÿç€è¦½å™¨è£¡ï¼ä¸æœƒä¸Šå‚³é›²ç«¯ï¼Œéš±ç§å®‰å…¨ã€‚</li><li><span className="font-bold">æ›æ‰‹æ©Ÿè³‡æ–™é‚„åœ¨å—ï¼Ÿ</span><br/>ä¸åœ¨å–”ï¼å»ºè­°æ¯é€±äº”ä½¿ç”¨ã€Œå ±è¡¨ã€åŠŸèƒ½åŒ¯å‡º Excel å‚™ä»½ã€‚</li></ul></div> <div className="text-center opacity-60 text-sm">Designed with â¤ï¸ for Teachers</div> </div> );
          const renderSettings = () => ( <div className="pb-24 space-y-8"> <button onClick={() => setActiveTab('manual')} className="w-full btn-3d bg-blue-soft py-4 text-coffee flex items-center justify-center gap-3 text-xl"><Icon name="BookOpen" className="w-7 h-7" /> ğŸ“– æŸ¥çœ‹ä½¿ç”¨èªªæ˜æ›¸</button> <div className="doodle-card p-5 bg-white border-4 border-yellow-200"> <h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"> <Icon name="Sparkles" className="w-8 h-8 text-yellow-500"/> AI æ™ºæ…§åŠ©ç†è¨­å®š </h3> <div className="mb-4"> <label className="text-lg font-bold opacity-70 mb-2 block">Gemini API Key (é¸å¡«)</label> <div className="flex gap-2"> <div className="relative flex-grow"> <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"><Icon name="Key" className="w-5 h-5"/></span> <input type="password" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} className="input-hand pl-10 text-lg" placeholder="è²¼ä¸Šæ‚¨çš„ API Key..." /> </div> {userApiKey && <span className="text-green-500 font-bold flex items-center">å·²å„²å­˜ âœ“</span>} </div> <p className="text-sm text-gray-500 mt-2"> <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline text-blue-500">é»æ­¤å…è²»å–å¾— Key</a>ã€‚è¨­å®šå¾Œå¯å•Ÿç”¨ã€Œæ™ºæ…§é€±å ±ã€èˆ‡ã€Œå¶ç™¼æ½¤é£¾ã€åŠŸèƒ½ã€‚ </p> </div> </div> <div className="doodle-card p-5 bg-white border-4 border-red-100"> <h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"> <Icon name="Save" className="w-8 h-8 text-red-500"/> è³‡æ–™å‚™ä»½èˆ‡ç®¡ç† </h3> <div className="grid grid-cols-1 md:grid-cols-2 gap-3"> <button onClick={handleBackupData} className="btn-3d bg-green-500 text-white py-3 px-4 flex items-center justify-center gap-2 text-lg"> <Icon name="Download" className="w-6 h-6"/> å‚™ä»½è³‡æ–™ (ä¸‹è¼‰) </button> <button onClick={() => backupInputRef.current.click()} className="btn-3d bg-blue-500 text-white py-3 px-4 flex items-center justify-center gap-2 text-lg"> <Icon name="RefreshCw" className="w-6 h-6"/> é‚„åŸè³‡æ–™ (ä¸Šå‚³) </button> <input type="file" ref={backupInputRef} onChange={handleRestoreData} style={{display:'none'}} accept=".json" /> <button onClick={handleResetData} className="btn-3d bg-red-500 text-white py-3 px-4 flex items-center justify-center gap-2 text-lg md:col-span-2 mt-2 border-red-800"> <Icon name="Trash" className="w-6 h-6"/> é‡ç½®æ‰€æœ‰è³‡æ–™ (æ¸…é™¤) </button> </div> <p className="text-sm text-gray-500 mt-2 text-center">é‡ç½®å‰è«‹å‹™å¿…å…ˆå‚™ä»½ï¼</p> </div> <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><Icon name="UserCog" className="w-8 h-8"/> å­¸ç”Ÿåå–®ç®¡ç†</h3> <div className="mb-6"> <label className="text-lg font-bold opacity-70 mb-2 block">åŒ¯å…¥åå–® (Excel / Word / åœ–ç‰‡è¾¨è­˜)</label> <div className="flex gap-2 mb-3"> <input type="file" ref={fileInputRef} onChange={(e) => { if(e.target.files[0]) processFile(e.target.files[0]); }} style={{display:'none'}} accept=".xlsx,.xls,.docx,image/*" /> <button onClick={() => fileInputRef.current.click()} className="btn-3d bg-white border-2 border-coffee py-2 px-4 flex items-center gap-2 text-coffee font-bold" disabled={isProcessing}> {isProcessing ? 'è™•ç†ä¸­...' : <><Icon name="Upload" className="w-5 h-5"/> ğŸ“ é¸æ“‡æª”æ¡ˆ</>} </button> <button onClick={() => fileInputRef.current.click()} className="btn-3d bg-white border-2 border-coffee py-2 px-4 flex items-center gap-2 text-coffee font-bold md:hidden"> <Icon name="Camera" className="w-5 h-5"/> æ‹ç…§ </button> </div> <textarea className="input-hand h-40 text-lg" placeholder="è§£æçµæœæœƒå‡ºç¾åœ¨é€™ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥è²¼ä¸Š...&#10;ç‹å°æ˜&#10;æå¤§åŒ" value={bulkNamesInput} onChange={(e) => setBulkNamesInput(e.target.value)} /> <button onClick={handleBulkImportNames} className="mt-4 w-full btn-3d bg-yellow py-3 text-coffee text-xl"><Icon name="Download" className="w-6 h-6 mr-2"/> åŒ¯å…¥åå–®</button> </div> <div className="max-h-60 overflow-y-auto border-t-2 border-coffee pt-4">{students.map(s => (<div key={s.id} className="flex items-center gap-2 mb-3"><span className="font-bold w-12 text-lg">#{s.id}</span><input type="text" value={s.name} onChange={(e) => handleUpdateStudentName(s.id, e.target.value)} className="input-hand py-2 text-lg" /></div>))}</div> </div> <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><Icon name="BookOpen" className="w-8 h-8"/> ç§‘ç›®ç®¡ç†</h3> <div className="flex gap-2 mb-4"> <input type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg" placeholder="è¼¸å…¥æ–°ç§‘ç›®åç¨±..." /> <button onClick={handleAddSubject} className="btn-3d bg-coffee text-white px-4 shrink-0 flex items-center gap-1"><Icon name="Plus" className="w-5 h-5"/><span>æ–°å¢</span></button> </div> <div className="flex flex-wrap gap-3">{subjects.map(s => ( <button key={s.id} onClick={(e) => { e.stopPropagation(); }} className="bg-gray-100 border-2 border-coffee px-3 py-2 rounded-full text-lg flex items-center gap-2 cursor-default"> {s.label} <span onClick={(e) => handleDeleteSubject(s.id, e)} className="ml-2 text-gray-400 hover:text-red-500 cursor-pointer p-1"> <Icon name="X" className="w-5 h-5"/> </span> </button> ))}</div> </div> </div> );
          const renderBasicInfo = () => ( <div className="space-y-6 pb-24"> <div className="doodle-card p-5 bg-white"> <div className="flex flex-wrap md:flex-nowrap gap-3 items-end"> <div className="flex-grow"> <label className="text-base font-bold opacity-70 block mb-1">ğŸ“… æ—¥æœŸ</label> <input type="date" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input-hand text-lg w-full" /> </div> <div className="w-1/3 md:w-auto"> <label className="text-base font-bold opacity-70 block mb-1">ğŸ—“ï¸ é€±æ¬¡</label> <select value={week} onChange={e => setWeek(e.target.value)} className="input-hand text-center text-lg h-[50px] bg-white w-full"> {Array.from({length: 22}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n}</option>)} </select> </div> <div className="w-1/2 md:w-auto flex-grow md:flex-grow-0"> <label className="text-base font-bold opacity-70 block mb-1">ğŸ“ å€¼æ—¥ç”Ÿ</label> <select value={dutyStudent} onChange={e => setDutyStudent(e.target.value)} className="input-hand text-lg h-[50px] bg-white w-full md:w-[120px]"> {Array.from({length: 35}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n} è™Ÿ</option>)} </select> </div> </div> </div> <div className="doodle-card p-5 bg-white relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-4 bg-mint border-b-2 border-coffee"></div><h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><Icon name="Clock" className="w-7 h-7" /> åˆ°æ ¡ç‹€æ³</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4">{ATTENDANCE_TYPES.map(type => { const count = attendanceData[type.id]?.length || 0; return <button key={type.id} onClick={() => handleAttendanceClick(type.id)} className={`btn-3d p-3 flex items-center justify-between px-4 ${type.color} text-lg h-14`}><div className="flex items-center gap-2"><Icon name={type.icon} className="w-5 h-5" /><span>{type.label}</span></div>{count > 0 && <span className="bg-coffee text-white text-sm px-3 py-1 rounded-full">{count}</span>}</button> })}</div></div> <div className="doodle-card p-5 bg-white relative overflow-hidden"> <div className="absolute top-0 left-0 w-full h-4 bg-yellow border-b-2 border-coffee"></div> <h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><Icon name="FileWarning" className="w-7 h-7" /> ä½œæ¥­èˆ‡è¯çµ¡ç°¿</h3> <div className="grid grid-cols-3 gap-2 mb-4"> {CONTACT_BOOK_TYPES.map(item => ( <button key={item.id} onClick={() => openSelector('missing', item.id)} className={`btn-3d flex flex-col items-center justify-center p-2 h-24 ${item.color} relative`}> <Icon name={item.icon} className="w-6 h-6 mb-1"/> <span className="text-sm text-center leading-tight w-full break-words px-1" style={{fontSize: '0.9rem'}}>{item.label}</span> {missingData[item.id]?.length > 0 && <span className="absolute top-[-5px] right-[-5px] w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center border-2 border-coffee text-xs z-10">{missingData[item.id].length}</span>} </button> ))} </div> <div className="border-t-2 border-coffee pt-4 space-y-4"> <div className="flex justify-between items-center"><h4 className="font-bold text-coffee opacity-80 text-lg">å„ç§‘ä½œæ¥­ç¼ºäº¤</h4><button onClick={() => setIsAddingSubject(!isAddingSubject)} className="text-sm bg-mint px-3 py-1 rounded-full border-2 border-coffee hover:bg-green-200"><Icon name="Plus" className="w-4 h-4" /></button></div> {isAddingSubject && <div className="flex gap-2"><input autoFocus type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg py-2" /><button onClick={handleAddSubject} className="btn-3d px-4 bg-coffee text-white text-lg">OK</button></div>} {subjects.length > 0 ? ( <div className="space-y-3"> <div className="flex gap-2"> <select value={currentSubjectId} onChange={(e) => setCurrentSubjectId(e.target.value)} className="input-hand text-lg flex-1 bg-gray-50 font-bold border-2 border-coffee">{subjects.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select> <button onClick={(e) => handleDeleteSubject(currentSubjectId, e)} className="btn-3d bg-pink text-white px-3"><Icon name="Trash2" className="w-6 h-6"/></button> </div> <button onClick={() => openSelector('missing', currentSubjectId)} className="btn-3d w-full bg-white py-4 text-lg flex justify-between px-5 border-2 border-coffee shadow-sm group active:bg-yellow"><span className="font-bold flex items-center gap-2"><Icon name="Edit3" className="w-5 h-5"/> ç™»è¨˜ {subjects.find(s=>s.id===currentSubjectId)?.label} ç¼ºäº¤</span>{missingData[currentSubjectId]?.length > 0 ? <span className="bg-pink text-white px-3 py-1 rounded-full text-sm font-bold">{missingData[currentSubjectId].length} äºº</span> : <span className="text-gray-400 text-sm">é»æ“Šç™»è¨˜</span>}</button> </div> ) : <div className="text-center text-gray-400 py-2">è«‹å…ˆæ–°å¢ç§‘ç›®...</div>} <div className="flex flex-wrap gap-2 mt-2">{subjects.map(s => { const count = missingData[s.id]?.length || 0; if (count === 0) return null; return ( <button key={s.id} onClick={() => { setCurrentSubjectId(s.id); openSelector('missing', s.id); }} className="bg-white border-2 border-coffee px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2 shadow-sm hover:bg-gray-50">{s.label} <span className="bg-pink text-white px-2 rounded-full text-xs">{count}</span></button> ) })}</div> </div> </div> </div> );
          const renderLog = () => ( <div className="space-y-5 pb-24"> <div className="doodle-card p-4 bg-white flex flex-col gap-3"> <div className="flex items-center gap-2"> <label className="font-bold text-coffee text-lg shrink-0">é¸æ“‡æ™‚æ®µï¼š</label> <select value={currentLogPeriod} onChange={(e) => setCurrentLogPeriod(e.target.value)} className="input-hand text-xl font-bold bg-yellow border-2 border-coffee py-2 flex-1"> {PERIODS.map(p => <option key={p.id} value={p.id}>{p.label}</option>)} </select> </div> <div className="relative"> <input type="text" value={periodNotes[currentLogPeriod] || ''} onChange={(e) => updatePeriodNote(e.target.value)} placeholder={`åœ¨æ­¤è¼¸å…¥${PERIODS.find(p=>p.id===currentLogPeriod)?.label}çš„å‚™è¨»...`} className="input-hand text-lg bg-gray-50 pr-10" /> <span className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"><Icon name="PenTool" className="w-5 h-5"/></span> </div> </div> <div className="flex justify-between items-center px-1"> <h4 className="font-bold text-coffee opacity-80 text-lg">é•è¦é …ç›®</h4> <button onClick={() => setIsEditingBehaviors(!isEditingBehaviors)} className={`px-3 py-1 rounded-full border-2 border-coffee text-sm font-bold flex items-center gap-1 ${isEditingBehaviors ? 'bg-pink text-white' : 'bg-gray-100'}`}><Icon name="Settings" className="w-4 h-4" /> {isEditingBehaviors ? 'å®Œæˆ' : 'ç·¨è¼¯'}</button> </div> {isEditingBehaviors && <div className="doodle-card p-4 bg-yellow flex gap-3"><input type="text" value={newBehaviorName} onChange={e => setNewBehaviorName(e.target.value)} placeholder="æ–°é•è¦é …ç›®..." className="input-hand text-lg" /><button onClick={handleAddBehavior} className="btn-3d bg-coffee text-white px-4 shrink-0 flex items-center gap-1"><Icon name="Plus" className="w-5 h-5"/><span>æ–°å¢</span></button></div>} <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"> {behaviors.map(behavior => { const count = classLogData[currentLogPeriod]?.[behavior.id]?.length || 0; return ( <button key={behavior.id} onClick={() => handleBehaviorClick(behavior.id)} className={`btn-3d p-2 flex flex-col items-center gap-1 ${behavior.color} min-h-[90px] relative`}> {isEditingBehaviors && <span onClick={(e) => handleDeleteBehavior(behavior.id, e)} className="absolute top-1 right-1 bg-white rounded-full p-1 border border-coffee text-red-500 z-20"><Icon name="X" className="w-4 h-4" strokeWidth={3} /></span>} <Icon name={behavior.icon} className="w-6 h-6" /> <span className="text-sm text-center leading-tight">{behavior.label}</span> {!isEditingBehaviors && count > 0 && <span className="absolute top-[-5px] right-[-5px] w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center border-2 border-coffee text-xs z-10">{count}</span>} </button> ) })} </div> <div className="mt-2 p-4 bg-white border-2 border-coffee rounded-2xl shadow-sm min-h-[80px]"> <p className="font-bold opacity-60 mb-2 text-sm border-b-2 border-coffee border-dashed pb-1 flex justify-between"> <span>{PERIODS.find(p=>p.id===currentLogPeriod)?.label} å·²ç´€éŒ„ï¼š</span> {(!classLogData[currentLogPeriod] || Object.values(classLogData[currentLogPeriod]).every(arr => arr.length === 0)) && !periodNotes[currentLogPeriod] && <span className="text-gray-400 font-normal">å°šç„¡è³‡æ–™</span>} </p> {behaviors.map(b => { const list = classLogData[currentLogPeriod]?.[b.id]; if(!list || list.length===0) return null; return ( <div key={b.id} className="flex gap-2 mb-1 text-lg"> <span className="font-bold text-coffee shrink-0">{b.label}:</span> <span className="text-gray-700">{list.map(id => students.find(s=>s.id===id)?.name || id).join('ã€')}</span> </div> ) })} {periodNotes[currentLogPeriod] && (<div className="flex gap-2 mt-2 text-lg text-blue-600 bg-blue-50 p-2 rounded-lg"><span className="font-bold shrink-0 flex items-center"><Icon name="PenTool" className="w-4 h-4 mr-1"/>å‚™è¨»:</span><span>{periodNotes[currentLogPeriod]}</span></div>)} </div> <div className="doodle-card p-5 bg-white mt-8"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2"><Icon name="MessageCircle" className="w-7 h-7" /> å…¨æ—¥å¶ç™¼/ç¸½çµ</h3><textarea value={incidentLog} onChange={(e) => setIncidentLog(e.target.value)} className="w-full h-32 p-4 border-2 border-coffee rounded-xl outline-none font-bold resize-none bg-gray-50 text-lg" placeholder="ä»Šæ—¥å…¶ä»–è£œå……..." /></div> </div> );
          const renderReview = () => { const dailyStudentViolations = getDailyStudentViolations(); const hasViolations = Object.keys(dailyStudentViolations).length > 0; return ( <div className="pb-24 space-y-5"> <div className="flex justify-end"><button onClick={exportDailyLog} className="btn-3d bg-yellow px-5 py-3 flex items-center gap-2 text-coffee font-bold text-lg"><Icon name="FileSpreadsheet" className="w-6 h-6"/> åŒ¯å‡ºä»Šæ—¥æ—¥èªŒ</button></div> <div className="bg-white border-2 border-coffee p-6 min-h-[500px] text-base font-mono shadow-xl relative leading-relaxed"> <h2 className="text-center text-2xl font-bold mb-6 border-b-2 border-coffee pb-3">{week || '____'}é€± ç­ç´šæ—¥èªŒ ({currentDate})</h2> <div className="mb-6 grid grid-cols-2 gap-4 text-lg"><div>å€¼æ—¥ç”Ÿ: {dutyStudent}è™Ÿ</div></div> <div className="mb-6 border border-coffee p-3"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">ç¼ºå‹¤</h3>{ATTENDANCE_TYPES.map(t => attendanceData[t.id]?.length > 0 && <div key={t.id} className="py-2 border-b border-dashed text-lg"><b>{t.label}:</b> {attendanceData[t.id].map(id=>students.find(s=>s.id===id)?.name || id).join('ã€')}</div>)}</div> <div className="mb-6 border border-coffee p-3"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">ç¼ºäº¤</h3>{CONTACT_BOOK_TYPES.map(t => missingData[t.id]?.length > 0 && <div key={t.id} className="py-2 border-b border-dashed text-lg"><b>{t.label}:</b> {missingData[t.id].map(id=>students.find(s=>s.id===id)?.name || id).join('ã€')}</div>)}{subjects.map(s => missingData[s.id]?.length > 0 && <div key={s.id} className="py-2 border-b border-dashed text-lg"><b>{s.label}:</b> {missingData[s.id].map(id=>students.find(s=>s.id===id)?.name || id).join('ã€')}</div>)}</div> <div className="mb-6 border border-coffee"> <h3 className="font-bold bg-red-100 p-2 border-b border-coffee text-lg text-red-800 flex items-center gap-2"><Icon name="AlertTriangle" className="w-5 h-5"/> ä»Šæ—¥é•è¦çµ±è¨ˆ (æŒ‰å­¸ç”Ÿ)</h3> <div className="p-3 space-y-2"> {hasViolations ? ( Object.entries(dailyStudentViolations).map(([studentId, violations]) => { const student = students.find(s => s.id === Number(studentId)); return ( <div key={studentId} className="border-b border-dashed last:border-0 pb-1"> <span className="font-bold text-lg text-coffee mr-2">{student?.name || `${studentId}è™Ÿ`}:</span> <span className="text-gray-700">{violations.join('ã€')}</span> </div> ); }) ) : ( <div className="text-center text-gray-400 py-2">ä»Šæ—¥ç„¡èª²å ‚é•è¦ç´€éŒ„ ğŸ‘</div> )} </div> </div> <div className="mb-6 border border-coffee"><h3 className="font-bold bg-gray-200 p-2 border-b border-coffee text-lg">èª²å ‚ç•°å¸¸æ˜ç´° & å‚™è¨»</h3>{PERIODS.map(p => { const logs=classLogData[p.id]; const note=periodNotes[p.id]; const hasLogs = logs && Object.keys(logs).some(k=>logs[k].length>0); if(!hasLogs && !note) return null; return ( <div key={p.id} className="p-3 border-b border-coffee last:border-0"> <div className="font-bold text-coffee mb-1 text-lg">{p.label}</div> {hasLogs && behaviors.map(b => logs[b.id]?.length > 0 && <div key={b.id} className="pl-4 flex text-lg"><span className="w-32 text-gray-600">- {b.label}:</span><span>{logs[b.id].map(id=>students.find(s=>s.id===id)?.name || id).join('ã€')}</span></div>)} {note && <div className="pl-4 text-lg text-blue-600 mt-1">å‚™è¨»: {note}</div>} </div> ) })}</div> <div className="border border-coffee p-3 min-h-[120px]"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">å…¨æ—¥å¶ç™¼</h3><p className="text-lg">{incidentLog}</p></div> </div> </div> ); };
          const renderReports = () => { const s = students.find(stud => stud.id === selectedStudentReport); const hasStudent = !!s; const statsData = hasStudent ? getWeeklyStats(selectedStudentReport) : { stats: { attendance: {}, missing: {}, behavior: {} }, attendanceDetails: [], missingDetails: [], behaviorDetails: [] }; const msg = hasStudent ? generateParentMessage(selectedStudentReport) : ""; return ( <div className="pb-24 space-y-6"> <div className="doodle-card p-4 bg-white border-4 border-blue-soft"><h3 className="font-bold mb-2 text-xl flex items-center gap-2 text-blue-600"><Icon name="Megaphone" className="w-6 h-6"/> è€å¸«çš„è©± (æ‰€æœ‰å­¸ç”Ÿéƒ½æœƒçœ‹åˆ°)</h3><textarea value={teacherNote} onChange={(e) => setTeacherNote(e.target.value)} className="w-full h-24 p-3 border-2 border-blue-200 rounded-xl outline-none text-lg bg-blue-50" placeholder="ä¾‹å¦‚ï¼šæ˜å¤©è¨˜å¾—ç©¿ç­æœã€ä¸‹é€±ä¸€æœŸä¸­è€ƒ..."/></div> <div className="doodle-card p-5 bg-yellow flex items-center justify-between"><div className="flex items-center gap-3"><Icon name="User" className="w-9 h-9" /><div><div className="text-sm opacity-60 font-bold">æŸ¥çœ‹å­¸ç”Ÿ</div><select value={selectedStudentReport} onChange={(e) => setSelectedStudentReport(Number(e.target.value))} className="bg-transparent text-2xl font-bold outline-none border-b-2 border-coffee min-w-[140px] py-1">{students.map(s => <option key={s.id} value={s.id}>{s.id}. {s.name}</option>)}</select></div></div><div className="text-right text-sm font-bold opacity-60">çµ±è¨ˆç¯„åœ<br/>éå» 5 å¤©</div></div> {hasStudent ? ( <> <div className="grid grid-cols-2 gap-4"><div className="doodle-card p-4 bg-white flex flex-col items-center justify-center min-h-[120px]"><div className="text-5xl font-bold text-coffee">{Object.values(statsData.stats.attendance).reduce((a,b)=>a+b, 0)}</div><div className="text-sm font-bold opacity-60 mt-1">æœ¬é€±ç¼ºå‹¤</div></div><div className="doodle-card p-4 bg-white flex flex-col items-center justify-center min-h-[120px]"><div className="text-5xl font-bold text-pink-500">{Object.values(statsData.stats.missing).reduce((a,b)=>a+b, 0)}</div><div className="text-sm font-bold opacity-60 mt-1">æœ¬é€±ç¼ºäº¤</div></div></div> <div className="space-y-4"> <div className="bg-white border-2 border-coffee p-4 rounded-xl text-lg whitespace-pre-wrap h-48 overflow-y-auto leading-relaxed shadow-inner">{msg}</div> <div className="flex gap-3 items-stretch"> <button onClick={() => handleLineShare(msg)} className="flex-[3] btn-3d bg-line py-4 text-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"> <Icon name="Send" className="w-6 h-6" /> å‚³é€/è¤‡è£½è¨Šæ¯çµ¦å®¶é•· </button> <button onClick={() => copyToClipboard(msg)} className="flex-1 btn-3d bg-mint py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80" title="åƒ…è¤‡è£½æ–‡å­—"> <Icon name="ClipboardCopy" className="w-6 h-6" /> <span>è¤‡è£½</span> </button> <button onClick={exportStudentWeekly} className="flex-1 btn-3d bg-gray-100 py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80" title="ä¸‹è¼‰ Excel"> <Icon name="Download" className="w-6 h-6" /> <span>ä¸‹è¼‰</span> </button> </div> </div> </> ) : ( <div className="p-8 text-center text-gray-500 font-bold text-xl mt-10">è«‹å…ˆå¾ä¸Šæ–¹é¸å–®é¸æ“‡ä¸€ä½å­¸ç”Ÿ</div> )} <div className="pt-4 border-t-4 border-dashed border-coffee opacity-60 space-y-3"> <button onClick={handlePrintAllStudents} className="w-full py-3 text-coffee bg-white border-2 border-coffee rounded-xl flex items-center justify-center gap-2 font-bold hover:bg-gray-50 transition"><Icon name="Printer" className="w-5 h-5"/> åˆ—å°å…¨ç­å®¶é•·é€šçŸ¥å–® (å«è©³æƒ…)</button> <button onClick={exportWholeClassWeekly} className="w-full py-3 text-coffee flex items-center justify-center gap-2 font-bold hover:bg-orange-100 rounded-xl transition"><Icon name="FileSpreadsheet" className="w-5 h-5"/> ä¸‹è¼‰å…¨ç­é€±å ±è¡¨ (Excel)</button> </div> </div> ); };

          return ( <div className="min-h-screen w-full max-w-4xl mx-auto relative overflow-hidden"> <style>{customStyles}</style> <header className="pt-8 pb-3 px-6 flex justify-between items-center"><h1 className="text-4xl font-bold text-coffee tracking-wider transform -rotate-1 flex items-center gap-3"><Icon name="BookOpen" className="w-10 h-10" /> ç­ç´šå°ç®¡å®¶</h1><button onClick={() => setActiveTab('manual')} className="bg-white p-2 rounded-full border-2 border-coffee shadow-sm active:scale-95 transition" title="ä½¿ç”¨èªªæ˜æ›¸"><Icon name="HelpCircle" className="w-7 h-7 text-coffee"/></button></header> <main className="px-5 h-full pt-4">{activeTab === 'basic' && renderBasicInfo()}{activeTab === 'log' && renderLog()}{activeTab === 'review' && renderReview()}{activeTab === 'report' && renderReports()}{activeTab === 'settings' && renderSettings()}{activeTab === 'manual' && renderManual()}</main> <StudentSelector /> <nav className="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[98%] max-w-xl bg-[#FFF] border-3 border-coffee rounded-2xl shadow-[4px_4px_0px_#5D4037] flex justify-between px-3 py-3 z-40"> {[{ id: 'basic', icon: 'User', label: 'é»å', color: 'bg-mint' }, { id: 'log', icon: 'Edit3', label: 'ç´€éŒ„', color: 'bg-yellow' }, { id: 'review', icon: 'List', label: 'æ—¥èªŒ', color: 'bg-pink' }, { id: 'report', icon: 'FileSpreadsheet', label: 'å ±è¡¨', color: 'bg-blue-soft' }, { id: 'settings', icon: 'Settings', label: 'è¨­å®š', color: 'bg-red-alert' }].map(tab => ( <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${tab.id === 'settings' ? 'nav-btn-settings ' + (activeTab === 'settings' ? 'active' : '') : (activeTab === tab.id ? `${tab.color} -translate-y-4 border-2 border-coffee shadow-sm` : 'opacity-60')}`}><div className={tab.id === 'settings' ? 'text-white' : 'text-coffee'}><Icon name={tab.icon} className="w-8 h-8"/></div><span className={`text-xs font-black mt-1 ${tab.id === 'settings' ? 'text-white' : 'text-coffee'}`}>{tab.label}</span></button> ))} </nav> </div> );
        }

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<ClassManagerLine />);
            setTimeout(() => {
                const loading = document.getElementById('loading-screen');
                if(loading) {
                    loading.style.opacity = '0';
                    setTimeout(() => loading.style.display = 'none', 500);
                }
            }, 1000); // å»¶é•·è‡³1ç§’ç¢ºä¿ç•«é¢ç©©å®š
        } catch (err) {
            console.error(err);
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerText += "å•Ÿå‹•å¤±æ•—: " + err.message;
        }
    </script>
</body>
</html>
